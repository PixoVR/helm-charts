{{- if and (.Values.enabled) (not .Values.local) }}
{{- if .Values.external_secrets.enabled }}
{{- if .Values.deploy_app }}

{{- if .Values.external_secrets.secret_store.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ include "secret_store" $ }}
  namespace: {{ .Release.Namespace }}
spec:
  provider:
    gcpsm:
      projectID: {{ include "app_project_id" $ }}

{{- end }}

{{- if .Values.cronjob.external_secrets.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: cronjob-secrets
  namespace: {{ .Release.Namespace }}
spec:
  {{- if .Values.external_secrets.refresh_interval }}
  refreshInterval: {{ .Values.external_secrets.refresh_interval }}
  {{- end }}
  secretStoreRef:
    kind: SecretStore
    name: {{ include "secret_store" $ }}
  target:
    name: cronjob-secrets
    creationPolicy: Owner
  data:
  {{- range .Values.cronjob.external_secrets.secrets }}
  - secretKey: {{ .secretKey }}
    remoteRef:
      key: {{ .remoteSecretKey }}
  {{- end }}

{{- end }}

{{- if .Values.external_secrets.app_secrets.extra_secrets }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: extra-app-secrets
  namespace: {{ .Release.Namespace }}
spec:
  {{- if .Values.external_secrets.refresh_interval }}
  refreshInterval: {{ .Values.external_secrets.refresh_interval }}
  {{- end }}
  secretStoreRef:
    kind: SecretStore
    name: {{ include "secret_store" $ }}
  target:
    name: extra-app-secrets
    creationPolicy: Owner
  data:
  {{- range .Values.external_secrets.app_secrets.extra_secrets }}
  - secretKey: {{ .secretKey }}
    remoteRef:
      key: {{ .remoteSecretKey }}
  {{- end }}

{{- end }}

{{- if .Values.github.credentials.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: github-credentials
  namespace: {{ .Release.Namespace }}
spec:
  {{- if .Values.external_secrets.refresh_interval }}
  refreshInterval: {{ .Values.external_secrets.refresh_interval }}
  {{- end }}
  secretStoreRef:
    kind: SecretStore
    name: {{ include "secret_store" $ }}
  target:
    name: github-credentials
    creationPolicy: Owner
  data:
  {{- if .Values.github.credentials.https.enabled }}
  - secretKey: github-https-username
    remoteRef:
      key: github-https-username
  - secretKey: github-https-password
    remoteRef:
      key: github-https-password
  {{- end }}
  {{- if .Values.github.credentials.pat.enabled }}
  - secretKey: github-access-token
    remoteRef:
      key: github-access-token
  {{- end }}
  {{- if .Values.github.credentials.ssh.enabled }}
  - secretKey: github-ssh-private-key
    remoteRef:
      key: github-ssh-private-key
  {{- end }}


{{- end }}

{{- if or (.Values.google.iap.enabled) (.Values.google.iap.test.enabled) (.Values.oauth.google.enabled) }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: oauth-credentials
  namespace: {{ .Release.Namespace }}
spec:
  {{- if .Values.external_secrets.refresh_interval }}
  refreshInterval: {{ .Values.external_secrets.refresh_interval }}
  {{- end }}
  secretStoreRef:
    kind: SecretStore
    name: {{ include "secret_store" $ }}
  target:
    name: oauth-credentials
    creationPolicy: Owner
  data:
  - secretKey: client_id
    remoteRef:
      key: google-oauth-id
  - secretKey: client_secret
    remoteRef:
      key: google-oauth-secret


{{- end }}

{{- if .Values.external_secrets.app_secrets.create }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: app-secrets
  namespace: {{ .Release.Namespace }}
spec:
  {{- if .Values.external_secrets.refresh_interval }}
  refreshInterval: {{ .Values.external_secrets.refresh_interval }}
  {{- end }}
  secretStoreRef:
    kind: SecretStore
    name: {{ include "secret_store" $ }}
  target:
    name: app-secrets
    creationPolicy: Owner
  data:

    - secretKey: auth-key
      remoteRef:
        key: {{ include "secrets_prefix" $ -}}-auth-key

    {{- if or (.Values.google.sql.enabled) (.Values.sql.proxy) }}
    {{- if .Values.google.sql.use_password }}
    - secretKey: db-password
      remoteRef:
        key: {{ include "secrets_prefix" $ -}}-db-password
    {{- end }}
    {{- end }}

    {{- if .Values.email.enabled }}
    {{- if .Values.email.mfa }}
    - secretKey: email-sender-password
      remoteRef:
        key: {{ include "secrets_prefix" $ -}}-email-sender-password
    {{- end }}
    {{- end }}

    {{- if .Values.external_auth }}
    - secretKey: external-auth-key
      remoteRef:
        key: {{ include "secrets_prefix" $ -}}-external-auth-key
    {{- end }}

    {{- if .Values.aws.auth.enabled }}
    - secretKey: aws-id
      remoteRef:
        key: {{ include "secrets_prefix" $ -}}-aws-id

    - secretKey: aws-secret
      remoteRef:
        key: {{ include "secrets_prefix" $ -}}-aws-secret
    {{- end }}

    {{- if .Values.aws.cloudfront.enabled }}
    - secretKey: aws-cf-private-key
      remoteRef:
        key: {{ include "secrets_prefix" $ -}}-aws-cf-private-key

    - secretKey: aws-cf-public-key
      remoteRef:
        key: {{ include "secrets_prefix" $ -}}-aws-cf-public-key

    - secretKey: aws-cf-domain
      remoteRef:
        key: {{ include "secrets_prefix" $ -}}-aws-cf-domain
    {{- end }}

    {{- if .Values.sa_json_key.enabled }}
    - secretKey: svc-acct-json-key
      remoteRef:
        key: {{ include "secrets_prefix" $ -}}-svc-acct-json-key
    {{- end }}

    {{- range .Values.external_secrets.extra_secrets }}
    - secretKey: svc-acct-json-key
      remoteRef:
        key: {{ include "secrets_prefix" $ -}}-svc-acct-json-key
    {{- end }}

{{- end }}

{{- end }}
{{- end }}

{{- end }}
